<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple NHS Capacity Planner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f4f8;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      color: #2563eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f1f5f9;
    }
    input[type="number"], input[type="text"] {
      width: 80px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      color: white;
    }
    .primary {
      background-color: #2563eb;
    }
    .success {
      background-color: #10b981;
    }
    .danger {
      background-color: #ef4444;
    }
    .warning {
      background-color: #f59e0b;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #e2e8f0;
      margin-right: 10px;
      border-radius: 4px;
    }
    .tab.active {
      background-color: #2563eb;
      color: white;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .negative {
      color: #ef4444;
    }
    .positive {
      color: #10b981;
    }
    @media print {
      button, .tabs {
        display: none;
      }
      body {
        background-color: white;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>NHS Appointment Capacity Planner</h1>
        <input type="text" id="practiceName" placeholder="Practice Name" value="My Practice">
      </div>
      
      <div class="tabs">
        <div class="tab" id="summaryTab">View Summary</div>
      </div>
      
      <div>
        <button class="success" id="saveBtn" title="Save plan to browser storage">Save Plan</button>
        <button class="primary" id="loadBtn" title="Load previously saved plan from browser storage">Load Saved Plan</button>
        <button class="warning" id="exportBtn" title="Export data to CSV file">Export CSV</button>
        <button class="primary" id="printBtn" title="Print current view">Print</button>
      </div>
    </div>
    
    <div id="inputPanel" style="display: block;">
      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div>
          <label>Appointments per normal session:</label>
          <input type="number" id="normalSession" value="12">
        </div>
      </div>
      
      <h3>Appointment Duration (minutes)</h3>
      <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;" id="appointmentDurations">
        <div>
          <label>GP:</label>
          <input type="number" id="gpMinutes" value="10" min="5" max="60" style="width: 60px;">
        </div>
        <div>
          <label>Nurse:</label>
          <input type="number" id="nurseMinutes" value="15" min="5" max="60" style="width: 60px;">
        </div>
        <div>
          <label>Pharmacist:</label>
          <input type="number" id="pharmacistMinutes" value="20" min="5" max="60" style="width: 60px;">
        </div>
        <div>
          <label>PA:</label>
          <input type="number" id="paMinutes" value="15" min="5" max="60" style="width: 60px;">
        </div>
        <div>
          <label>ANP:</label>
          <input type="number" id="anpMinutes" value="15" min="5" max="60" style="width: 60px;">
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4>Add New Role Type</h4>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="newRoleName" placeholder="Role name" style="width: 150px;">
          <label>Minutes:</label>
          <input type="number" id="newRoleMinutes" value="15" min="5" max="60" style="width: 60px;">
          <button id="addRoleBtn" class="success">Add Role</button>
        </div>
      </div>
      
      <h2>Demand Data</h2>
      <table>
        <thead>
          <tr>
            <th>Data Type</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Reactive Demand Slots</td>
            <td><input type="number" id="reactive-0" value="0" class="reactive"></td>
            <td><input type="number" id="reactive-1" value="0" class="reactive"></td>
            <td><input type="number" id="reactive-2" value="0" class="reactive"></td>
            <td><input type="number" id="reactive-3" value="0" class="reactive"></td>
            <td><input type="number" id="reactive-4" value="0" class="reactive"></td>
            <td id="reactiveTotal">0</td>
          </tr>
          <tr>
            <td>Unmet Demand</td>
            <td><input type="number" id="unmet-0" value="0" class="unmet"></td>
            <td><input type="number" id="unmet-1" value="0" class="unmet"></td>
            <td><input type="number" id="unmet-2" value="0" class="unmet"></td>
            <td><input type="number" id="unmet-3" value="0" class="unmet"></td>
            <td><input type="number" id="unmet-4" value="0" class="unmet"></td>
            <td id="unmetTotal">0</td>
          </tr>
          <tr style="background-color: #dbeafe;">
            <td><strong>Total Demand</strong></td>
            <td id="totalDemand-0">0</td>
            <td id="totalDemand-1">0</td>
            <td id="totalDemand-2">0</td>
            <td id="totalDemand-3">0</td>
            <td id="totalDemand-4">0</td>
            <td id="totalDemandTotal">0</td>
          </tr>
          <tr>
            <td>Regular Blocked Appointments</td>
            <td><input type="number" id="regularBlocked-0" value="0" class="regularBlocked"></td>
            <td><input type="number" id="regularBlocked-1" value="0" class="regularBlocked"></td>
            <td><input type="number" id="regularBlocked-2" value="0" class="regularBlocked"></td>
            <td><input type="number" id="regularBlocked-3" value="0" class="regularBlocked"></td>
            <td><input type="number" id="regularBlocked-4" value="0" class="regularBlocked"></td>
            <td id="regularBlockedTotal">0</td>
          </tr>
          <tr>
            <td>Ad Hoc Blocked Appointments</td>
            <td><input type="number" id="adHocBlocked-0" value="0" class="adHocBlocked"></td>
            <td><input type="number" id="adHocBlocked-1" value="0" class="adHocBlocked"></td>
            <td><input type="number" id="adHocBlocked-2" value="0" class="adHocBlocked"></td>
            <td><input type="number" id="adHocBlocked-3" value="0" class="adHocBlocked"></td>
            <td><input type="number" id="adHocBlocked-4" value="0" class="adHocBlocked"></td>
            <td id="adHocBlockedTotal">0</td>
          </tr>
          <tr style="background-color: #fee2e2;">
            <td><strong>Total Capacity Required (appointments)</strong></td>
            <td id="totalRequired-0">0</td>
            <td id="totalRequired-1">0</td>
            <td id="totalRequired-2">0</td>
            <td id="totalRequired-3">0</td>
            <td id="totalRequired-4">0</td>
            <td id="totalRequiredTotal">0</td>
          </tr>
          <tr style="background-color: #fee2e2;">
            <td><strong>Total Capacity Required (sessions)</strong></td>
            <td id="requiredSessions-0">0.0</td>
            <td id="requiredSessions-1">0.0</td>
            <td id="requiredSessions-2">0.0</td>
            <td id="requiredSessions-3">0.0</td>
            <td id="requiredSessions-4">0.0</td>
            <td id="requiredSessionsTotal">0.0</td>
          </tr>
        </tbody>
      </table>
      
      <h2>Staff Data</h2>
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <div></div>
        <div>
          <input type="text" id="newStaffName" placeholder="Staff Name">
          <select id="newStaffType">
            <option value="GP">GP</option>
            <option value="Nurse">Nurse</option>
            <option value="Pharmacist">Pharmacist</option>
            <option value="PA">PA</option>
            <option value="ANP">ANP</option>
          </select>
          <button class="primary" id="addStaffBtn">Add Staff</button>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>Staff</th>
            <th>Type</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="staffTableBody">
          <!-- Staff rows will be added here -->
        </tbody>
        <tr style="background-color: #d1fae5;">
          <td colspan="2"><strong>Total Capacity</strong></td>
          <td id="totalCapacity-0">0</td>
          <td id="totalCapacity-1">0</td>
          <td id="totalCapacity-2">0</td>
          <td id="totalCapacity-3">0</td>
          <td id="totalCapacity-4">0</td>
          <td id="totalCapacityTotal">0</td>
          <td></td>
        </tr>
      </table>
      
      <h2>Surplus/Deficit</h2>
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Capacity vs Demand (Appointments)</strong></td>
            <td id="surplus-0">0</td>
            <td id="surplus-1">0</td>
            <td id="surplus-2">0</td>
            <td id="surplus-3">0</td>
            <td id="surplus-4">0</td>
            <td id="surplusTotal">0</td>
          </tr>
          <tr>
            <td><strong>Minutes</strong></td>
            <td id="minutes-0">0</td>
            <td id="minutes-1">0</td>
            <td id="minutes-2">0</td>
            <td id="minutes-3">0</td>
            <td id="minutes-4">0</td>
            <td id="minutesTotal">0</td>
          </tr>
          <tr>
            <td><strong>Sessions (est.)</strong></td>
            <td id="sessions-0">0.0</td>
            <td id="sessions-1">0.0</td>
            <td id="sessions-2">0.0</td>
            <td id="sessions-3">0.0</td>
            <td id="sessions-4">0.0</td>
            <td id="sessionsTotal">0.0</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div id="summaryPanel" style="display: none;">
      <h2>Capacity Summary</h2>
      
      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        <div style="flex: 1; min-width: 300px;">
          <h3>Weekly Summary</h3>
          <table>
            <tbody>
              <tr>
                <td>Reactive Demand</td>
                <td id="summaryReactiveTotal">0</td>
              </tr>
              <tr>
                <td>Unmet Demand</td>
                <td id="summaryUnmetTotal">0</td>
              </tr>
              <tr>
                <td>Total Demand</td>
                <td id="summaryTotalDemand">0</td>
              </tr>
              <tr>
                <td>Blocked Appointments</td>
                <td id="summaryBlockedTotal">0</td>
              </tr>
              <tr style="background-color: #fee2e2;">
                <td><strong>Total Capacity Required</strong></td>
                <td id="summaryRequiredTotal">0</td>
              </tr>
              <tr>
                <td>Total Capacity Available</td>
                <td id="summaryTotalCapacity">0</td>
              </tr>
              <tr id="summaryOverallRow">
                <td><strong>Overall Surplus/Deficit (Appointments)</strong></td>
                <td id="summaryOverall">0</td>
              </tr>
              <tr>
                <td><strong>Total Minutes Surplus/Deficit</strong></td>
                <td id="summaryMinutes">0</td>
              </tr>
              <tr>
                <td>Estimated Sessions Required (week)</td>
                <td id="summaryRequiredSessions">0.0</td>
              </tr>
              <tr>
                <td>Estimated Sessions Available (week)</td>
                <td id="summaryEstimatedSessions">0.0</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="flex: 1; min-width: 300px;">
          <h3>Staff Breakdown</h3>
          <table>
            <thead>
              <tr>
                <th>Staff Type</th>
                <th>Count</th>
                <th>Total Appointments</th>
              </tr>
            </thead>
            <tbody id="staffBreakdownBody">
              <!-- Staff breakdown will be added here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <h3>Daily Capacity vs Demand Chart</h3>
      <div id="capacityChart" style="height: 300px; width: 100%; margin-top: 20px;">
        <!-- Chart will be rendered here -->
      </div>
      
      <h3>Minutes Surplus/Deficit By Day</h3>
      <div id="minutesChart" style="height: 300px; width: 100%; margin-top: 20px;">
        <!-- Chart will be rendered here -->
      </div>
      
      <style>
        /* Chart styles */
        .bar-chart {
          display: flex;
          align-items: flex-end;
          height: 250px;
          width: 100%;
          border-bottom: 2px solid #ccc;
          margin-top: 10px;
        }
        .bar-container {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          height: 100%;
          position: relative;
        }
        .bar {
          width: 40px;
          background-color: #3B82F6;
          transition: height 0.3s ease;
          position: relative;
          border-radius: 3px 3px 0 0;
        }
        .bar-demand {
          background-color: #EF4444;
          position: absolute;
          bottom: 0;
          width: 40px;
          border-radius: 3px 3px 0 0;
        }
        .bar-label {
          margin-top: 5px;
          font-weight: bold;
        }
        .value-label {
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          background-color: rgba(255,255,255,0.8);
          padding: 2px 4px;
          border-radius: 2px;
          font-size: 12px;
        }
        .surplus-bar {
          width: 60px;
          border-radius: 3px;
          transition: height 0.3s ease;
        }
        .positive-bar {
          background-color: #10B981;
          align-self: flex-end;
        }
        .negative-bar {
          background-color: #EF4444;
          align-self: flex-end;
        }
        .x-axis {
          display: flex;
          justify-content: space-around;
          width: 100%;
          margin-top: 5px;
        }
        .x-label {
          font-weight: bold;
        }
        .zero-line {
          position: absolute;
          width: 100%;
          height: 2px;
          background-color: #666;
          bottom: 0;
        }
      </style>
    </div>
  </div>

  <script>
    // Initialize data
    let practiceName = 'My Practice';
    let normalSession = 12;
    let appointmentMinutes = {
      'GP': 10,
      'Nurse': 15,
      'Pharmacist': 20,
      'PA': 15,
      'ANP': 15
    };
    let reactiveSlots = [0, 0, 0, 0, 0];
    let unmetDemand = [0, 0, 0, 0, 0];
    let totalDemand = [0, 0, 0, 0, 0];
    let regularBlocked = [0, 0, 0, 0, 0];
    let adHocBlocked = [0, 0, 0, 0, 0];
    let totalRequired = [0, 0, 0, 0, 0];
    let staffMembers = [
      { id: 1, name: 'Dr 1', type: 'GP', mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 },
      { id: 2, name: 'Dr 2', type: 'GP', mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 },
      { id: 3, name: 'Nurse', type: 'Nurse', mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }
    ];
    let totalCapacity = [0, 0, 0, 0, 0];
    let surplus = [0, 0, 0, 0, 0];
    
    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
    const staffTypes = ['GP', 'Nurse', 'Pharmacist', 'PA', 'ANP'];
    
    // DOM References
    const practiceNameInput = document.getElementById('practiceName');
    const normalSessionInput = document.getElementById('normalSession');
    const gpMinutesInput = document.getElementById('gpMinutes');
    const nurseMinutesInput = document.getElementById('nurseMinutes');
    const pharmacistMinutesInput = document.getElementById('pharmacistMinutes');
    const paMinutesInput = document.getElementById('paMinutes');
    const anpMinutesInput = document.getElementById('anpMinutes');
    const summaryTab = document.getElementById('summaryTab');
    const inputPanel = document.getElementById('inputPanel');
    const summaryPanel = document.getElementById('summaryPanel');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const exportBtn = document.getElementById('exportBtn');
    const printBtn = document.getElementById('printBtn');
    const addStaffBtn = document.getElementById('addStaffBtn');
    const newStaffNameInput = document.getElementById('newStaffName');
    const newStaffTypeSelect = document.getElementById('newStaffType');
    const staffTableBody = document.getElementById('staffTableBody');
    const staffBreakdownBody = document.getElementById('staffBreakdownBody');
    
    // Initialize the UI
    function initializeUI() {
      // Set up event listeners
      practiceNameInput.addEventListener('input', e => practiceName = e.target.value);
      normalSessionInput.addEventListener('input', e => {
        normalSession = parseInt(e.target.value) || 0;
        calculateAll();
      });
      
      // Set up appointment duration listeners
      gpMinutesInput.addEventListener('input', e => {
        appointmentMinutes['GP'] = parseInt(e.target.value) || 10;
        calculateAll();
      });
      nurseMinutesInput.addEventListener('input', e => {
        appointmentMinutes['Nurse'] = parseInt(e.target.value) || 15;
        calculateAll();
      });
      pharmacistMinutesInput.addEventListener('input', e => {
        appointmentMinutes['Pharmacist'] = parseInt(e.target.value) || 20;
        calculateAll();
      });
      paMinutesInput.addEventListener('input', e => {
        appointmentMinutes['PA'] = parseInt(e.target.value) || 15;
        calculateAll();
      });
      anpMinutesInput.addEventListener('input', e => {
        appointmentMinutes['ANP'] = parseInt(e.target.value) || 15;
        calculateAll();
      });
      
      // Set up add role button
      document.getElementById('addRoleBtn').addEventListener('click', addNewRole);
      
      summaryTab.addEventListener('click', () => {
        summaryTab.classList.add('active');
        inputPanel.style.display = 'none';
        summaryPanel.style.display = 'block';
        updateSummary();
      });
      
      saveBtn.addEventListener('click', savePlan);
      loadBtn.addEventListener('click', loadPlan);
      exportBtn.addEventListener('click', exportToCSV);
      printBtn.addEventListener('click', () => window.print());
      
      addStaffBtn.addEventListener('click', addStaffMember);
      
      // Set up reactive input listeners
      document.querySelectorAll('.reactive').forEach((input, index) => {
        input.addEventListener('input', e => {
          reactiveSlots[index] = parseInt(e.target.value) || 0;
          calculateAll();
        });
      });
      
      // Set up unmet demand input listeners
      document.querySelectorAll('.unmet').forEach((input, index) => {
        input.addEventListener('input', e => {
          unmetDemand[index] = parseInt(e.target.value) || 0;
          calculateAll();
        });
      });
      
      // Set up regular blocked appointments input listeners
      document.querySelectorAll('.regularBlocked').forEach((input, index) => {
        input.addEventListener('input', e => {
          regularBlocked[index] = parseInt(e.target.value) || 0;
          calculateAll();
        });
      });
      
      // Set up ad hoc blocked appointments input listeners
      document.querySelectorAll('.adHocBlocked').forEach((input, index) => {
        input.addEventListener('input', e => {
          adHocBlocked[index] = parseInt(e.target.value) || 0;
          calculateAll();
        });
      });
      
      // Render staff table
      renderStaffTable();
      
      // Calculate all values
      calculateAll();
    }
    
    // Calculate all derived values
    function calculateAll() {
      // Calculate total demand
      for (let i = 0; i < 5; i++) {
        totalDemand[i] = reactiveSlots[i] + unmetDemand[i];
      }
      
      // Calculate total required capacity (demand + blocked)
      for (let i = 0; i < 5; i++) {
        totalRequired[i] = totalDemand[i] + regularBlocked[i] + adHocBlocked[i];
      }
      
      // Calculate total capacity
      totalCapacity = [0, 0, 0, 0, 0];
      staffMembers.forEach(staff => {
        totalCapacity[0] += staff.mon;
        totalCapacity[1] += staff.tue;
        totalCapacity[2] += staff.wed;
        totalCapacity[3] += staff.thu;
        totalCapacity[4] += staff.fri;
      });
      
      // Calculate surplus/deficit (vs total required now, not just demand)
      for (let i = 0; i < 5; i++) {
        surplus[i] = totalCapacity[i] - totalRequired[i];
      }
      
      // Update UI with calculated values
      updateUI();
    }
    
    // Update UI with calculated values
    function updateUI() {
      // Update reactive total
      const reactiveTotal = reactiveSlots.reduce((sum, val) => sum + val, 0);
      document.getElementById('reactiveTotal').textContent = reactiveTotal;
      
      // Update unmet total
      const unmetTotal = unmetDemand.reduce((sum, val) => sum + val, 0);
      document.getElementById('unmetTotal').textContent = unmetTotal;
      
      // Update total demand
      for (let i = 0; i < 5; i++) {
        document.getElementById(`totalDemand-${i}`).textContent = totalDemand[i];
      }
      const totalDemandTotal = totalDemand.reduce((sum, val) => sum + val, 0);
      document.getElementById('totalDemandTotal').textContent = totalDemandTotal;
      
      // Update regular blocked appointments total
      const regularBlockedTotal = regularBlocked.reduce((sum, val) => sum + val, 0);
      document.getElementById('regularBlockedTotal').textContent = regularBlockedTotal;
      
      // Update ad hoc blocked appointments total
      const adHocBlockedTotal = adHocBlocked.reduce((sum, val) => sum + val, 0);
      document.getElementById('adHocBlockedTotal').textContent = adHocBlockedTotal;
      
      // Update total required capacity
      for (let i = 0; i < 5; i++) {
        document.getElementById(`totalRequired-${i}`).textContent = totalRequired[i];
      }
      const totalRequiredTotal = totalRequired.reduce((sum, val) => sum + val, 0);
      document.getElementById('totalRequiredTotal').textContent = totalRequiredTotal;
      
      // Update required sessions
      for (let i = 0; i < 5; i++) {
        const sessionsRequired = normalSession > 0 ? (totalRequired[i] / normalSession).toFixed(1) : '0.0';
        document.getElementById(`requiredSessions-${i}`).textContent = sessionsRequired;
      }
      const requiredSessionsTotal = normalSession > 0 ? (totalRequiredTotal / normalSession).toFixed(1) : '0.0';
      document.getElementById('requiredSessionsTotal').textContent = requiredSessionsTotal;
      
      // Update total capacity
      for (let i = 0; i < 5; i++) {
        document.getElementById(`totalCapacity-${i}`).textContent = totalCapacity[i];
      }
      const totalCapacityTotal = totalCapacity.reduce((sum, val) => sum + val, 0);
      document.getElementById('totalCapacityTotal').textContent = totalCapacityTotal;
      
      // Update surplus/deficit
      for (let i = 0; i < 5; i++) {
        const surplusElement = document.getElementById(`surplus-${i}`);
        surplusElement.textContent = surplus[i];
        surplusElement.className = surplus[i] < 0 ? 'negative' : surplus[i] > 0 ? 'positive' : '';
      }
      const surplusTotal = surplus.reduce((sum, val) => sum + val, 0);
      const surplusTotalElement = document.getElementById('surplusTotal');
      surplusTotalElement.textContent = surplusTotal;
      surplusTotalElement.className = surplusTotal < 0 ? 'negative' : surplusTotal > 0 ? 'positive' : '';
      
      // Calculate minutes based on staff types
      let minutesValues = [0, 0, 0, 0, 0];
      let minutesTotal = 0;
      
      // Calculate minutes for each day using staff type-specific durations
      for (let i = 0; i < 5; i++) {
        if (surplus[i] < 0) {
          // For deficit (negative surplus), use the average appointment duration
          // since we don't know which staff type's appointments are not being met
          const totalStaffMinutes = staffTypes.reduce((sum, type) => sum + appointmentMinutes[type], 0);
          const avgMinutes = totalStaffMinutes / staffTypes.length;
          minutesValues[i] = surplus[i] * avgMinutes;
        } else {
          // For surplus, we know exactly which staff type contributes to the surplus
          const dayField = days[i];
          const staffTypeMinutes = {};
          
          // Initialize counters for each staff type
          staffTypes.forEach(type => {
            staffTypeMinutes[type] = 0;
          });
          
          // Count the total appointments for each staff type on this day
          staffMembers.forEach(staff => {
            if (staff[dayField] > 0) {
              staffTypeMinutes[staff.type] += staff[dayField];
            }
          });
          
          // Apply duration for each staff type
          let dayMinutes = 0;
          staffTypes.forEach(type => {
            if (staffTypeMinutes[type] > 0) {
              dayMinutes += staffTypeMinutes[type] * appointmentMinutes[type];
            }
          });
          
          // Subtract demand (assuming average duration for demand)
          const totalStaffMinutes = staffTypes.reduce((sum, type) => sum + appointmentMinutes[type], 0);
          const avgMinutes = totalStaffMinutes / staffTypes.length;
          dayMinutes -= totalDemand[i] * avgMinutes;
          
          minutesValues[i] = dayMinutes;
        }
        minutesTotal += minutesValues[i];
      }
      
      // Update UI with calculated minutes
      for (let i = 0; i < 5; i++) {
        const minutesElement = document.getElementById(`minutes-${i}`);
        minutesElement.textContent = Math.round(minutesValues[i]);
        minutesElement.className = minutesValues[i] < 0 ? 'negative' : minutesValues[i] > 0 ? 'positive' : '';
      }
      
      const minutesTotalElement = document.getElementById('minutesTotal');
      minutesTotalElement.textContent = Math.round(minutesTotal);
      minutesTotalElement.className = minutesTotal < 0 ? 'negative' : minutesTotal > 0 ? 'positive' : '';
      
      // Update sessions
      for (let i = 0; i < 5; i++) {
        const sessionsElement = document.getElementById(`sessions-${i}`);
        const sessionValue = normalSession > 0 ? (surplus[i] / normalSession).toFixed(1) : '0.0';
        sessionsElement.textContent = sessionValue;
        sessionsElement.className = surplus[i] < 0 ? 'negative' : surplus[i] > 0 ? 'positive' : '';
      }
      const sessionsTotal = normalSession > 0 ? (surplusTotal / normalSession).toFixed(1) : '0.0';
      const sessionsTotalElement = document.getElementById('sessionsTotal');
      sessionsTotalElement.textContent = sessionsTotal;
      sessionsTotalElement.className = surplusTotal < 0 ? 'negative' : surplusTotal > 0 ? 'positive' : '';
    }
    
    // Add a new staff member
    function addStaffMember() {
      const name = newStaffNameInput.value.trim();
      if (!name) {
        alert('Please enter a name for the staff member');
        return;
      }
      
      const type = newStaffTypeSelect.value;
      const newStaff = {
        id: Date.now(),
        name: name,
        type: type,
        mon: 0,
        tue: 0,
        wed: 0,
        thu: 0,
        fri: 0
      };
      
      staffMembers.push(newStaff);
      newStaffNameInput.value = '';
      newStaffTypeSelect.value = 'GP';
      
      renderStaffTable();
      calculateAll();
    }
    
    // Remove a staff member
    function removeStaffMember(id) {
      staffMembers = staffMembers.filter(staff => staff.id !== id);
      renderStaffTable();
      calculateAll();
    }
    
    // Update staff appointment
    function updateStaffAppointment(id, day, value) {
      const newValue = parseInt(value) || 0;
      staffMembers = staffMembers.map(staff => {
        if (staff.id === id) {
          return { ...staff, [day]: newValue };
        }
        return staff;
      });
      calculateAll();
    }
    
    // Render staff table
    function renderStaffTable() {
      staffTableBody.innerHTML = '';
      
      staffMembers.forEach(staff => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${staff.name}</td>
          <td>${staff.type}</td>
          <td><input type="number" value="${staff.mon}" onchange="updateStaffAppointment(${staff.id}, 'mon', this.value)"></td>
          <td><input type="number" value="${staff.tue}" onchange="updateStaffAppointment(${staff.id}, 'tue', this.value)"></td>
          <td><input type="number" value="${staff.wed}" onchange="updateStaffAppointment(${staff.id}, 'wed', this.value)"></td>
          <td><input type="number" value="${staff.thu}" onchange="updateStaffAppointment(${staff.id}, 'thu', this.value)"></td>
          <td><input type="number" value="${staff.fri}" onchange="updateStaffAppointment(${staff.id}, 'fri', this.value)"></td>
          <td>${staff.mon + staff.tue + staff.wed + staff.thu + staff.fri}</td>
          <td><button class="danger" onclick="removeStaffMember(${staff.id})">Remove</button></td>
        `;
        
        staffTableBody.appendChild(row);
      });
    }
    
    // Update summary panel
    function updateSummary() {
      const reactiveTotal = reactiveSlots.reduce((sum, val) => sum + val, 0);
      const unmetTotal = unmetDemand.reduce((sum, val) => sum + val, 0);
      const totalDemandTotal = totalDemand.reduce((sum, val) => sum + val, 0);
      const regularBlockedTotal = regularBlocked.reduce((sum, val) => sum + val, 0);
      const adHocBlockedTotal = adHocBlocked.reduce((sum, val) => sum + val, 0);
      const blockedTotal = regularBlockedTotal + adHocBlockedTotal;
      const totalRequiredTotal = totalRequired.reduce((sum, val) => sum + val, 0);
      const totalCapacityTotal = totalCapacity.reduce((sum, val) => sum + val, 0);
      const surplusTotal = surplus.reduce((sum, val) => sum + val, 0);
      
      // Calculate total minutes
      let totalMinutes = 0;
      
      // Calculate minutes for each day (reusing the same logic from updateUI)
      let minutesValues = [0, 0, 0, 0, 0];
      
      // Calculate minutes for each day using staff type-specific durations
      for (let i = 0; i < 5; i++) {
        if (surplus[i] < 0) {
          // For deficit (negative surplus), use the average appointment duration
          const totalStaffMinutes = staffTypes.reduce((sum, type) => sum + appointmentMinutes[type], 0);
          const avgMinutes = totalStaffMinutes / staffTypes.length;
          minutesValues[i] = surplus[i] * avgMinutes;
        } else {
          // For surplus, we know exactly which staff type contributes to the surplus
          const dayField = days[i];
          const staffTypeMinutes = {};
          
          // Initialize counters for each staff type
          staffTypes.forEach(type => {
            staffTypeMinutes[type] = 0;
          });
          
          // Count the total appointments for each staff type on this day
          staffMembers.forEach(staff => {
            if (staff[dayField] > 0) {
              staffTypeMinutes[staff.type] += staff[dayField];
            }
          });
          
          // Apply duration for each staff type
          let dayMinutes = 0;
          staffTypes.forEach(type => {
            if (staffTypeMinutes[type] > 0) {
              dayMinutes += staffTypeMinutes[type] * appointmentMinutes[type];
            }
          });
          
          // Subtract demand (assuming average duration for demand)
          const totalStaffMinutes = staffTypes.reduce((sum, type) => sum + appointmentMinutes[type], 0);
          const avgMinutes = totalStaffMinutes / staffTypes.length;
          dayMinutes -= totalDemand[i] * avgMinutes;
          
          minutesValues[i] = dayMinutes;
        }
        totalMinutes += minutesValues[i];
      }
      
      // For each staff type, count total appointments
      const staffTypeAppointments = {};
      staffTypes.forEach(type => {
        staffTypeAppointments[type] = 0;
      });
      
      staffMembers.forEach(staff => {
        days.forEach((day, i) => {
          if (staff[day] > 0) {
            staffTypeAppointments[staff.type] += staff[day];
          }
        });
      });
      
      document.getElementById('summaryReactiveTotal').textContent = reactiveTotal;
      document.getElementById('summaryUnmetTotal').textContent = unmetTotal;
      document.getElementById('summaryTotalDemand').textContent = totalDemandTotal;
      document.getElementById('summaryBlockedTotal').textContent = blockedTotal;
      document.getElementById('summaryRequiredTotal').textContent = totalRequiredTotal;
      document.getElementById('summaryTotalCapacity').textContent = totalCapacityTotal;
      
      const summaryOverall = document.getElementById('summaryOverall');
      summaryOverall.textContent = surplusTotal;
      summaryOverall.className = surplusTotal < 0 ? 'negative' : surplusTotal > 0 ? 'positive' : '';
      
      const summaryMinutes = document.getElementById('summaryMinutes');
      summaryMinutes.textContent = Math.round(totalMinutes);
      summaryMinutes.className = totalMinutes < 0 ? 'negative' : totalMinutes > 0 ? 'positive' : '';
      
      const summaryOverallRow = document.getElementById('summaryOverallRow');
      summaryOverallRow.style.backgroundColor = surplusTotal < 0 ? '#fee2e2' : surplusTotal > 0 ? '#d1fae5' : '';
      
      document.getElementById('summaryRequiredSessions').textContent = 
        normalSession > 0 ? (totalRequiredTotal / normalSession).toFixed(1) : '0.0';
        
      document.getElementById('summaryEstimatedSessions').textContent = 
        normalSession > 0 ? (totalCapacityTotal / normalSession).toFixed(1) : '0.0';
      
      // Create capacity vs demand chart
      const capacityChartElement = document.getElementById('capacityChart');
      capacityChartElement.innerHTML = '';
      
      // Create chart container
      const capacityChart = document.createElement('div');
      capacityChart.className = 'bar-chart';
      
      // Find max value for scaling
      const maxCapacityDemand = Math.max(
        ...totalCapacity, 
        ...totalRequired,
        1  // Ensure at least 1 to avoid division by zero
      );
      
      // Add bars for each day
      days.forEach((day, i) => {
        const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);
        const container = document.createElement('div');
        container.className = 'bar-container';
        
        // Calculate heights as percentages
        const capacityHeight = (totalCapacity[i] / maxCapacityDemand) * 100;
        const requiredHeight = (totalRequired[i] / maxCapacityDemand) * 100;
        
        // Create capacity bar (blue)
        const capacityBar = document.createElement('div');
        capacityBar.className = 'bar';
        capacityBar.style.height = `${capacityHeight}%`;
        
        // Create capacity value label
        const capacityLabel = document.createElement('div');
        capacityLabel.className = 'value-label';
        capacityLabel.textContent = totalCapacity[i];
        capacityBar.appendChild(capacityLabel);
        
        // Create required capacity bar (red)
        const requiredBar = document.createElement('div');
        requiredBar.className = 'bar-demand';
        requiredBar.style.height = `${requiredHeight}%`;
        
        // Create required capacity value label
        const requiredLabel = document.createElement('div');
        requiredLabel.className = 'value-label';
        requiredLabel.textContent = totalRequired[i];
        requiredBar.appendChild(requiredLabel);
        
        // Create day label
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = dayLabel;
        
        // Add elements to container
        container.appendChild(capacityBar);
        container.appendChild(requiredBar);
        capacityChart.appendChild(container);
        
        // Add day label under the bar
        const dayLabelDiv = document.createElement('div');
        dayLabelDiv.className = 'x-label';
        dayLabelDiv.textContent = dayLabel;
        container.appendChild(dayLabelDiv);
      });
      
      capacityChartElement.appendChild(capacityChart);
      
      // Create minutes chart
      const minutesChartElement = document.getElementById('minutesChart');
      minutesChartElement.innerHTML = '';
      
      // Create chart container for minutes
      const minutesChart = document.createElement('div');
      minutesChart.className = 'bar-chart';
      
      // Find max value for scaling (absolute value to handle negatives)
      const maxMinutes = Math.max(
        ...minutesValues.map(val => Math.abs(val)),
        60  // Minimum scale to make small values visible
      );
      
      // Add bars for each day
      days.forEach((day, i) => {
        const dayLabel = day.charAt(0).toUpperCase() + day.slice(1);
        const container = document.createElement('div');
        container.className = 'bar-container';
        
        // Create zero line for minutes chart
        const zeroLine = document.createElement('div');
        zeroLine.className = 'zero-line';
        container.appendChild(zeroLine);
        
        // Calculate height as percentage
        const minutesHeight = (Math.abs(minutesValues[i]) / maxMinutes) * 100;
        
        // Create minutes bar
        const minutesBar = document.createElement('div');
        minutesBar.className = `surplus-bar ${minutesValues[i] >= 0 ? 'positive-bar' : 'negative-bar'}`;
        minutesBar.style.height = `${minutesHeight}%`;
        
        // Add transform for negative values to go downward
        if (minutesValues[i] < 0) {
          minutesBar.style.transform = 'rotateX(180deg)';
          minutesBar.style.transformOrigin = 'bottom';
        }
        
        // Add value label
        const valueLabel = document.createElement('div');
        valueLabel.className = 'value-label';
        valueLabel.textContent = Math.round(minutesValues[i]);
        minutesBar.appendChild(valueLabel);
        
        // Add day label
        const label = document.createElement('div');
        label.className = 'x-label';
        label.textContent = dayLabel;
        
        // Add elements to container
        container.appendChild(minutesBar);
        container.appendChild(label);
        minutesChart.appendChild(container);
      });
      
      minutesChartElement.appendChild(minutesChart);
      
      // Render staff breakdown
      staffBreakdownBody.innerHTML = '';
      
      // Group staff by type
      const staffByType = {};
      staffTypes.forEach(type => {
        staffByType[type] = {
          count: 0,
          appointments: 0
        };
      });
      
      staffMembers.forEach(staff => {
        if (staffByType[staff.type]) {
          staffByType[staff.type].count++;
          staffByType[staff.type].appointments += 
            staff.mon + staff.tue + staff.wed + staff.thu + staff.fri;
        }
      });
      
      // Create rows for each staff type with appointments
      Object.keys(staffByType).forEach(type => {
        if (staffByType[type].count > 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${type}</td>
            <td>${staffByType[type].count}</td>
            <td>${staffByType[type].appointments}</td>
          `;
          staffBreakdownBody.appendChild(row);
        }
      });
    }
    
    // Save plan to localStorage
    function savePlan() {
      const planData = {
        practiceName,
        normalSession,
        appointmentMinutes,
        reactiveSlots,
        unmetDemand,
        regularBlocked,
        adHocBlocked,
        staffMembers
      };
      
      try {
        localStorage.setItem('capacityPlannerData', JSON.stringify(planData));
        alert('Plan saved to your browser\'s local storage. You can retrieve it later using the "Load Saved Plan" button.');
      } catch (error) {
        console.error('Error saving plan', error);
        alert('Error saving plan. Your browser might have restrictions on local storage.');
      }
    }
    
    // Load plan from localStorage
    function loadPlan() {
      try {
        const savedPlan = localStorage.getItem('capacityPlannerData');
        if (savedPlan) {
          const planData = JSON.parse(savedPlan);
          
          // Display a confirmation dialog before loading
          if (confirm('This will replace your current data with the previously saved plan. Continue?')) {
            practiceName = planData.practiceName || 'My Practice';
            practiceNameInput.value = practiceName;
            
            normalSession = planData.normalSession || 12;
            normalSessionInput.value = normalSession;
            
            // Load appointment durations
            if (planData.appointmentMinutes) {
              appointmentMinutes = planData.appointmentMinutes;
              
              // Update UI inputs
              gpMinutesInput.value = appointmentMinutes['GP'] || 10;
              nurseMinutesInput.value = appointmentMinutes['Nurse'] || 15;
              pharmacistMinutesInput.value = appointmentMinutes['Pharmacist'] || 20;
              paMinutesInput.value = appointmentMinutes['PA'] || 15;
              anpMinutesInput.value = appointmentMinutes['ANP'] || 15;
              
              // Load any custom roles that were added
              Object.keys(appointmentMinutes).forEach(type => {
                if (!staffTypes.includes(type) && type !== 'GP' && type !== 'Nurse' && 
                    type !== 'Pharmacist' && type !== 'PA' && type !== 'ANP') {
                  // Add this custom role to staffTypes
                  staffTypes.push(type);
                  
                  // Add to staff type dropdown
                  const option = document.createElement('option');
                  option.value = type;
                  option.textContent = type;
                  newStaffTypeSelect.appendChild(option);
                  
                  // Add UI element for duration
                  const durationsContainer = document.getElementById('appointmentDurations');
                  const durationElement = document.createElement('div');
                  durationElement.innerHTML = `
                    <label>${type}:</label>
                    <input type="number" id="${type.toLowerCase()}Minutes" value="${appointmentMinutes[type]}" min="5" max="60" style="width: 60px;">
                  `;
                  durationsContainer.appendChild(durationElement);
                  
                  // Add event listener for the new input
                  const newInput = document.getElementById(`${type.toLowerCase()}Minutes`);
                  if (newInput) {
                    newInput.addEventListener('input', e => {
                      appointmentMinutes[type] = parseInt(e.target.value) || appointmentMinutes[type];
                      calculateAll();
                    });
                  }
                }
              });
            }
            
            reactiveSlots = planData.reactiveSlots || [0, 0, 0, 0, 0];
            reactiveSlots.forEach((value, index) => {
              document.getElementById(`reactive-${index}`).value = value;
            });
            
            unmetDemand = planData.unmetDemand || [0, 0, 0, 0, 0];
            unmetDemand.forEach((value, index) => {
              document.getElementById(`unmet-${index}`).value = value;
            });
            
            // Load blocked appointments data
            regularBlocked = planData.regularBlocked || [0, 0, 0, 0, 0];
            regularBlocked.forEach((value, index) => {
              document.getElementById(`regularBlocked-${index}`).value = value;
            });
            
            adHocBlocked = planData.adHocBlocked || [0, 0, 0, 0, 0];
            adHocBlocked.forEach((value, index) => {
              document.getElementById(`adHocBlocked-${index}`).value = value;
            });
            
            staffMembers = planData.staffMembers || [];
            renderStaffTable();
            
            calculateAll();
            alert('Plan loaded successfully from browser storage');
          }
        } else {
          alert('No saved plan found in your browser\'s storage');
        }
      } catch (error) {
        console.error('Error loading plan', error);
        alert('Error loading plan from browser storage');
      }
    }
    
    // Export to CSV
    function exportToCSV() {
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add header
      csvContent += `NHS Capacity Planner - ${practiceName}\n\n`;
      csvContent += `Appointment Duration (minutes):\n`;
      csvContent += `GP: ${appointmentMinutes['GP']}, Nurse: ${appointmentMinutes['Nurse']}, Pharmacist: ${appointmentMinutes['Pharmacist']}, PA: ${appointmentMinutes['PA']}, ANP: ${appointmentMinutes['ANP']}\n\n`;
      
      // Add demand data
      csvContent += "DEMAND DATA,Mon,Tue,Wed,Thu,Fri,Total\n";
      csvContent += `Reactive Slots,${reactiveSlots.join(',')},${reactiveSlots.reduce((a, b) => a + b, 0)}\n`;
      csvContent += `Unmet Demand,${unmetDemand.join(',')},${unmetDemand.reduce((a, b) => a + b, 0)}\n`;
      csvContent += `Total Demand,${totalDemand.join(',')},${totalDemand.reduce((a, b) => a + b, 0)}\n`;
      csvContent += `Regular Blocked,${regularBlocked.join(',')},${regularBlocked.reduce((a, b) => a + b, 0)}\n`;
      csvContent += `Ad Hoc Blocked,${adHocBlocked.join(',')},${adHocBlocked.reduce((a, b) => a + b, 0)}\n`;
      csvContent += `Total Capacity Required,${totalRequired.join(',')},${totalRequired.reduce((a, b) => a + b, 0)}\n\n`;
      
      // Add staff capacity
      csvContent += "STAFF CAPACITY,Type,Mon,Tue,Wed,Thu,Fri,Total\n";
      staffMembers.forEach(staff => {
        const total = staff.mon + staff.tue + staff.wed + staff.thu + staff.fri;
        csvContent += `${staff.name},${staff.type},${staff.mon},${staff.tue},${staff.wed},${staff.thu},${staff.fri},${total}\n`;
      });
      
      // Add total capacity
      csvContent += `Total Capacity,,${totalCapacity.join(',')},${totalCapacity.reduce((a, b) => a + b, 0)}\n\n`;
      
      // Add surplus/deficit
      csvContent += `Surplus/Deficit (Appointments),,${surplus.join(',')},${surplus.reduce((a, b) => a + b, 0)}\n`;
      
      // Calculate minutes for CSV (same calculation as in updateUI)
      let minutesValues = [0, 0, 0, 0, 0];
      let minutesTotal = 0;
      
      // Calculate minutes for each day using staff type-specific durations
      for (let i = 0; i < 5; i++) {
        if (surplus[i] < 0) {
          // For deficit (negative surplus), use the average appointment duration
          const totalStaffMinutes = staffTypes.reduce((sum, type) => sum + appointmentMinutes[type], 0);
          const avgMinutes = totalStaffMinutes / staffTypes.length;
          minutesValues[i] = Math.round(surplus[i] * avgMinutes);
        } else {
          // For surplus, we know exactly which staff type contributes to the surplus
          const dayField = days[i];
          const staffTypeMinutes = {};
          
          // Initialize counters for each staff type
          staffTypes.forEach(type => {
            staffTypeMinutes[type] = 0;
          });
          
          // Count the total appointments for each staff type on this day
          staffMembers.forEach(staff => {
            if (staff[dayField] > 0) {
              staffTypeMinutes[staff.type] += staff[dayField];
            }
          });
          
          // Apply duration for each staff type
          let dayMinutes = 0;
          staffTypes.forEach(type => {
            if (staffTypeMinutes[type] > 0) {
              dayMinutes += staffTypeMinutes[type] * appointmentMinutes[type];
            }
          });
          
          // Subtract demand (assuming average duration for demand)
          const totalStaffMinutes = staffTypes.reduce((sum, type) => sum + appointmentMinutes[type], 0);
          const avgMinutes = totalStaffMinutes / staffTypes.length;
          dayMinutes -= totalDemand[i] * avgMinutes;
          
          minutesValues[i] = Math.round(dayMinutes);
        }
        minutesTotal += minutesValues[i];
      }
      
      csvContent += `Minutes,,${minutesValues.join(',')},${Math.round(minutesTotal)}\n`;
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `${practiceName.replace(/\s+/g, '_')}_Capacity_Plan.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Make staff update function available globally
    window.updateStaffAppointment = updateStaffAppointment;
    window.removeStaffMember = removeStaffMember;
    
    // Add New Role Type
    function addNewRole() {
      const roleName = document.getElementById('newRoleName').value.trim();
      const roleMinutes = parseInt(document.getElementById('newRoleMinutes').value) || 15;
      
      if (!roleName) {
        alert('Please enter a name for the role');
        return;
      }
      
      // Check if role already exists
      if (staffTypes.includes(roleName)) {
        alert('This role type already exists');
        return;
      }
      
      // Add to staff types array
      staffTypes.push(roleName);
      
      // Add to appointment minutes object
      appointmentMinutes[roleName] = roleMinutes;
      
      // Add to staff type dropdown
      const option = document.createElement('option');
      option.value = roleName;
      option.textContent = roleName;
      newStaffTypeSelect.appendChild(option);
      
      // Add UI element for duration
      const durationsContainer = document.getElementById('appointmentDurations');
      const durationElement = document.createElement('div');
      durationElement.innerHTML = `
        <label>${roleName}:</label>
        <input type="number" id="${roleName.toLowerCase()}Minutes" value="${roleMinutes}" min="5" max="60" style="width: 60px;">
      `;
      durationsContainer.appendChild(durationElement);
      
      // Add event listener for the new input
      const newInput = document.getElementById(`${roleName.toLowerCase()}Minutes`);
      newInput.addEventListener('input', e => {
        appointmentMinutes[roleName] = parseInt(e.target.value) || roleMinutes;
        calculateAll();
      });
      
      // Clear input fields
      document.getElementById('newRoleName').value = '';
      document.getElementById('newRoleMinutes').value = '15';
      
      // Update calculations
      calculateAll();
    }
    
    // Initialize the application
    initializeUI();
  </script>
</body>
</html>